rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is the owner of the resource
    function isOwner(resourceData) {
      return resourceData.creatorId == request.auth.uid;
    }

    // Questions Collection
    match /questions/{questionId} {
      // READ: Allow any authenticated user to read questions
      allow read: if isAuthenticated();
      
      // CREATE: Allow authenticated users to create if they mark themselves as creator
      allow create: if isAuthenticated() && request.resource.data.creatorId == request.auth.uid;
      
      // UPDATE: Allow authenticated users to update, but protect ownership fields
      // Critical fields (creatorId, uniqueId) cannot be changed after creation
      allow update: if isAuthenticated()
        && request.resource.data.creatorId == resource.data.creatorId
        && request.resource.data.uniqueId == resource.data.uniqueId;
      
      // DELETE: Only the owner can delete their question
      allow delete: if isAuthenticated() && isOwner(resource.data);
    }

    // User Settings (Custom Tags, etc.)
    match /userSettings/{userId} {
      // Users can only read/write their own settings
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // API Usage Logging
    match /apiUsage/{docId} {
      // Cloud Functions writer only (Client cannot write directly)
      allow read, write: if false; 
    }
    
    // Default: Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
